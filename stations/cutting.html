<!DOCTYPE html>
<html>
<head>
    <title>Cutting Station</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        body { margin: 0; background: #f5f5f5; font-family: Arial; }
        .container { max-width: 400px; margin: 0 auto; background: white; min-height: 100vh; }
        .header { background: #4CAF50; color: white; padding: 20px; text-align: center; }
        .scan-btn { background: #4CAF50; color: white; border: none; padding: 20px; font-size: 18px; border-radius: 10px; width: 90%; margin: 20px auto; display: block; }
        .hidden { display: none; }
        .instruction-item { padding: 15px; border-bottom: 1px solid #eee; }
        .back-btn { background: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî™ Cutting Station</h1>
            <p>Scan fruit batch QR code</p>
        </div>

        <div id="scannerSection">
            <button class="scan-btn" onclick="startCamera()">üì∑ SCAN BATCH QR CODE</button>
            <video id="video" class="hidden" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <button class="scan-btn back-btn" onclick="window.location.href='../index.html'">‚Üê BACK TO MAIN</button>
        </div>

        <div id="instructionsSection" class="hidden">
            <h2 id="fruitTitle"></h2>
            <div id="instructionsList"></div>
            <div id="inputFields"></div>
            <button class="scan-btn" onclick="completeOperation()">‚úÖ MARK COMPLETED</button>
            <button class="scan-btn back-btn" onclick="showScanner()">SCAN NEW BATCH</button>
        </div>
    </div>

    <script>
        let currentBatch = '';
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let scanning = true;
        
        async function startCamera() {
            try {
                scanning = true;
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.classList.remove('hidden');
                canvas.classList.remove('hidden'); // FIX 1: Show canvas
                scanQRCode();

                // FIX 3: Fallback if no QR detected
                setTimeout(() => {
                    if (scanning) {
                        console.warn("No QR detected. Using demo data.");
                        simulateQRScan('mango_cutting');
                    }
                }, 8000);
            } catch (err) {
                alert("Camera access denied. Please allow camera permissions.");
                setTimeout(() => simulateQRScan('mango_cutting'), 2000);
            }
        }

        function scanQRCode() {
            const context = canvas.getContext('2d');
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    // FIX 2: Add logging
                    console.log("Scanning frame...");
                    if (code) {
                        console.log("QR code detected:", code.data);
                        scanning = false;
                        if (video.srcObject) {
                            video.srcObject.getTracks().forEach(track => track.stop());
                            video.classList.add('hidden');
                            canvas.classList.add('hidden');
                        }
                        loadInstructions(code.data);
                        return;
                    }
                }
                requestAnimationFrame(tick);
            }
            tick();
        }

        function simulateQRScan(fruitType) {
            scanning = false;
            loadInstructions(fruitType);
        }

        async function loadInstructions(fruitType) {
            try {
                const response = await fetch(`../instructions/${fruitType}.json`);
                const data = await response.json();
                
                document.getElementById('fruitTitle').textContent = data.station + ' Station';
                document.getElementById('instructionsList').innerHTML = 
                    data.steps.map(step => `<div class="instruction-item">${step}</div>`).join('');
                
                document.getElementById('scannerSection').classList.add('hidden');
                document.getElementById('instructionsSection').classList.remove('hidden');
                
            } catch (error) {
                alert("Error loading instructions. Using demo data.");
                showDemoInstructions();
            }
        }

        function showDemoInstructions() {
            document.getElementById('fruitTitle').textContent = 'Cutting Station';
            document.getElementById('instructionsList').innerHTML = `
                <div class="instruction-item">1. Remove stems and pits</div>
                <div class="instruction-item">2. Cut into uniform 2cm cubes</div>
                <div class="instruction-item">3. Separate pulp from skin</div>
                <div class="instruction-item">4. Collect in food-grade containers</div>
            `;
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('instructionsSection').classList.remove('hidden');
        }

        function showScanner() {
            scanning = false;
            document.getElementById('scannerSection').classList.remove('hidden');
            document.getElementById('instructionsSection').classList.add('hidden');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        function completeOperation() {
            alert('Operation completed! Batch recorded.');
            showScanner();
        }
    </script>
</body>
</html>
