<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  let scanning = false;

  function startCamera() {
    // Hide button, show camera
    document.querySelector('button').style.display = 'none';
    const video = document.getElementById('video');
    video.classList.remove('hidden');
    
    // Start camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.play();
        scanning = true;
        scanForQRCode();
      })
      .catch(err => {
        alert("Camera error: " + err.message);
      });
  }

  function scanForQRCode() {
    if (!scanning) return;
    
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      
      if (code) {
        scanning = false;
        showBatchResult(code.data);
        return;
      }
    }
    
    // Keep scanning
    requestAnimationFrame(scanForQRCode);
  }

  function showBatchResult(batchNumber) {
    // Stop camera
    const video = document.getElementById('video');
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
    }
    
    // Show results
    document.getElementById('scannerSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.remove('hidden');
    document.getElementById('batchNumber').textContent = batchNumber;
  }

  function startOver() {
    // Reset everything
    scanning = false;
    document.getElementById('scannerSection').classList.remove('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.querySelector('button').style.display = 'block';
    document.getElementById('video').classList.add('hidden');
  }
</script>